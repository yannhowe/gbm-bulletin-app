#!/bin/bash

DATE=`date +%Y-%m-%d-%H-%M-%S`

case "$1" in
        start)
            docker-compose rm -f nginx website bulletin bulletin-static bulletin-postgres bulletin-redis
            docker-compose pull
            docker-compose up --build -d
            docker-compose ps
            ;;

        stop)
            docker-compose stop -t 1
            docker-compose rm -f nginx website bulletin bulletin-static bulletin-postgres bulletin-redis
            docker-compose ps
            ;;
        rebuild)
            docker-compose stop -t 1
            docker-compose rm -f nginx website bulletin bulletin-static bulletin-postgres bulletin-redis
            docker-compose pull
            docker-compose up --build -d
            docker-compose ps
            ;;
        dev)
            docker-compose stop -t 1
            docker-compose rm -f nginx website bulletin bulletin-static bulletin-postgres bulletin-redis
            docker-compose pull
            docker-compose -f docker-compose.dev.yml up --build -d
            docker-compose ps
            ;;
        status)
            docker-compose ps
            ;;
        clean)
            docker stop $(docker ps -a -q)
            docker rm $(docker ps -a -q)
            ;;
        nuke)
            docker stop $(docker ps -a -q)
            docker rm $(docker ps -a -q)
            docker rmi $(docker images -a)
            docker volume rm $(docker volume ls |awk '{print $2}')
            ;;
        init)
            echo running migrations....
            docker-compose run --rm bulletin python manage.py migrate
            echo creating superuser
            docker-compose run --rm bulletin python manage.py createsuperuser --email admin@gbm.sg --username admin
            ;;
        migrate)
            docker-compose run --rm bulletin python manage.py makemigrations
            docker-compose run --rm bulletin python manage.py migrate
            ;;
        dump_live)
            echo dumping data only from gbm.sg
            pg_dump -v -a -h gbm.sg -Fc -o -U postgres postgres > prod_db.$DATE.data.dump
            pg_dump -v -s -h gbm.sg -Fc -o -U postgres postgres > prod_db.$DATE.schema.dump
            pg_dump -v -h gbm.sg -Fc -o -U postgres postgres > prod_db.$DATE.full.dump
            ;;

        *)
            echo $"Usage: $0 {start|stop|rebuild|dev|status|clean|nuke|init|migrate|dump_live}"
            exit 1

esac
